<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入場確認画面のプレビュー</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 全体のフォントをInterに設定し、背景と中央寄せを設定 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
        }
    </style>
</head>
<body>

    <!-- コンテンツを囲むカード形式のコンテナ -->
    <div class="max-w-lg w-full p-8 bg-white rounded-2xl shadow-2xl text-center border border-gray-100 transform hover:scale-[1.01] transition-transform duration-300">
        
        <!-- ユーザーが提供したコンテンツ -->
        <div class="initial-check">
            <h2 class="text-3xl font-extrabold text-green-600 mb-4 sm:text-4xl">
                ✅ 2回目の入場を確認しました！
            </h2>
            <p class="text-gray-700 mt-6 text-xl sm:text-2xl leading-relaxed">
                スタッフにこの画面を見せ、再入場処理を完了してください。
            </p>
        </div>

        <!-- Local Storageのコードを再挿入 -->
        <script>
            const VISITED_KEY = 'festival_visited_count';
            
            try {
                // NOTE: このCanvas環境では、localStorageはデータ永続化に使用できません。
                // 永続化にはFirebase Firestoreを使用する必要があります。
                localStorage.setItem(VISITED_KEY, '3');
                console.log("Local Storageの訪問回数を '3' に設定しました。");
            } catch (e) {
                console.error("Local Storageへの書き込みに失敗しました:", e);
            }
        </script>
        
        <!-- 認証情報を表示するための要素 -->
        <div class="mt-8 pt-4 border-t border-gray-200">
             <p id="auth-status" class="text-xs text-gray-500 break-all"></p>
        </div>
    </div>

    <!-- Firebase SDKの読み込みと初期化 (Canvas環境で必須) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Canvas環境から提供されるグローバル変数を使用
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;

        const authStatusElement = document.getElementById('auth-status');

        async function initializeFirebase() {
            try {
                // Firebase Appの初期化
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized.");

                    // 認証処理
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        authStatusElement.innerHTML = '認証ステータス: カスタム認証でサインイン済み';
                    } else {
                        await signInAnonymously(auth);
                        authStatusElement.innerHTML = '認証ステータス: 匿名認証でサインイン済み';
                    }
                    
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    authStatusElement.innerHTML += `<br>ユーザーID (App ID: ${appId}): ${userId}`;

                } else {
                    console.error("Firebase configuration is missing.");
                    authStatusElement.textContent = 'Firebase設定が不足しています。';
                }
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                authStatusElement.textContent = `認証エラー: ${error.message}`;
            }
        }

        initializeFirebase();

        // 外部からアクセスできるよう、グローバルスコープに公開（デバッグ用）
        window.db = db;
        window.auth = auth;
    </script>
    
</body>
</html>
